{% extends "base.html" %}

{% block title %}个人设置 - Tiny微博{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">个人资料设置</h4>
                </div>
                <div class="card-body">
                    {% if not current_user.is_profile_completed %}
                    <div class="alert alert-warning" role="alert">
                        请完善您的个人信息以加入相应的圈子
                    </div>
                    {% endif %}

                    <form method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <!-- 头像上传 -->
                        <div class="mb-4">
                            <label for="avatar" class="form-label">头像</label>
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    {% if current_user.avatar %}
                                    <img src="{{ url_for('static', filename=current_user.avatar) }}" 
                                         alt="当前头像" class="rounded-circle" 
                                         style="width: 100px; height: 100px; object-fit: cover;">
                                    {% else %}
                                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center"
                                         style="width: 100px; height: 100px;">
                                        <i class="bi bi-person-circle" style="font-size: 3rem;"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <input type="file" class="form-control" id="avatar" name="avatar" accept="image/*">
                                    <div class="form-text">支持 jpg、png、gif 格式，建议尺寸 200x200</div>
                                </div>
                            </div>
                        </div>

                        <!-- 昵称 -->
                        <div class="mb-4">
                            <label for="nickname" class="form-label">昵称</label>
                            <input type="text" class="form-control" id="nickname" name="nickname" 
                                   value="{{ current_user.nickname or '' }}" required>
                        </div>

                        <!-- 故乡地区 -->
                        <div class="mb-4">
                            <h5 class="mb-3">故乡</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <select class="form-select" id="hometown_province" name="hometown_province" required>
                                        <option value="">选择省份</option>
                                        {% for province in provinces %}
                                        <option value="{{ province.id }}" 
                                                {% if current_user.hometown_province_id == province.id %}selected{% endif %}>
                                            {{ province.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="hometown_city" name="hometown_city" required>
                                        <option value="">选择城市</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="hometown_district" name="hometown_district" required>
                                        <option value="">选择区县</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 现居地区 -->
                        <div class="mb-4">
                            <h5 class="mb-3">现居地</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <select class="form-select" id="current_province" name="current_province" required>
                                        <option value="">选择省份</option>
                                        {% for province in provinces %}
                                        <option value="{{ province.id }}"
                                                {% if current_user.current_province_id == province.id %}selected{% endif %}>
                                            {{ province.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="current_city" name="current_city" required>
                                        <option value="">选择城市</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="current_district" name="current_district" required>
                                        <option value="">选择区县</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">保存修改</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 加载城市数据
async function loadCities(provinceId, citySelect, districtSelect, defaultCityId = null) {
    citySelect.innerHTML = '<option value="">选择城市</option>';
    districtSelect.innerHTML = '<option value="">选择区县</option>';
    
    if (!provinceId) return;
    
    try {
        const response = await fetch(`/api/regions/cities/${provinceId}`);
        const cities = await response.json();
        
        cities.forEach(city => {
            const option = document.createElement('option');
            option.value = city.id;
            option.textContent = city.name;
            if (defaultCityId && city.id == defaultCityId) {
                option.selected = true;
            }
            citySelect.appendChild(option);
        });
        
        if (defaultCityId) {
            await loadDistricts(defaultCityId, districtSelect);
        }
    } catch (error) {
        console.error('加载城市数据失败:', error);
    }
}

// 加载区县数据
async function loadDistricts(cityId, districtSelect, defaultDistrictId = null) {
    districtSelect.innerHTML = '<option value="">选择区县</option>';
    
    if (!cityId) return;
    
    try {
        const response = await fetch(`/api/regions/districts/${cityId}`);
        const districts = await response.json();
        
        districts.forEach(district => {
            const option = document.createElement('option');
            option.value = district.id;
            option.textContent = district.name;
            if (defaultDistrictId && district.id == defaultDistrictId) {
                option.selected = true;
            }
            districtSelect.appendChild(option);
        });
    } catch (error) {
        console.error('加载区县数据失败:', error);
    }
}

// 初始化故乡地区选择器
const hometownProvince = document.getElementById('hometown_province');
const hometownCity = document.getElementById('hometown_city');
const hometownDistrict = document.getElementById('hometown_district');

hometownProvince.addEventListener('change', () => {
    loadCities(hometownProvince.value, hometownCity, hometownDistrict);
});

hometownCity.addEventListener('change', () => {
    loadDistricts(hometownCity.value, hometownDistrict);
});

// 初始化现居地区选择器
const currentProvince = document.getElementById('current_province');
const currentCity = document.getElementById('current_city');
const currentDistrict = document.getElementById('current_district');

currentProvince.addEventListener('change', () => {
    loadCities(currentProvince.value, currentCity, currentDistrict);
});

currentCity.addEventListener('change', () => {
    loadDistricts(currentCity.value, currentDistrict);
});

// 页面加载时初始化已有的选择
document.addEventListener('DOMContentLoaded', async () => {
    // 初始化故乡地区
    if (hometownProvince.value) {
        await loadCities(
            hometownProvince.value, 
            hometownCity, 
            hometownDistrict, 
            {{ current_user.hometown_city_id or 'null' }}
        );
        if (hometownCity.value) {
            await loadDistricts(
                hometownCity.value, 
                hometownDistrict, 
                {{ current_user.hometown_district_id or 'null' }}
            );
        }
    }
    
    // 初始化现居地区
    if (currentProvince.value) {
        await loadCities(
            currentProvince.value, 
            currentCity, 
            currentDistrict, 
            {{ current_user.current_city_id or 'null' }}
        );
        if (currentCity.value) {
            await loadDistricts(
                currentCity.value, 
                currentDistrict, 
                {{ current_user.current_district_id or 'null' }}
            );
        }
    }
});

// 头像预览
document.getElementById('avatar').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.querySelector('img.rounded-circle') || 
                       document.createElement('img');
            img.src = e.target.result;
            img.classList.add('rounded-circle');
            img.style.width = '100px';
            img.style.height = '100px';
            img.style.objectFit = 'cover';
            
            const iconContainer = document.querySelector('.bi-person-circle')?.parentElement;
            if (iconContainer) {
                iconContainer.replaceWith(img);
            }
        }
        reader.readAsDataURL(file);
    }
});
</script>
{% endblock %} 