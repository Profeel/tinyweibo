import os
from app import app, db, Region

def init_db():
    # 删除现有数据库
    if os.path.exists('instance/microblog.db'):
        os.remove('instance/microblog.db')
    
    # 创建新数据库
    with app.app_context():
        db.create_all()
        
        # 初始化地区数据
        provinces_data = {
            '北京市': ['东城区', '西城区', '朝阳区', '海淀区', '丰台区', '石景山区', '门头沟区', '房山区', '通州区', '顺义区', '昌平区', '大兴区', '怀柔区', '平谷区', '密云区', '延庆区'],
            '上海市': ['黄浦区', '徐汇区', '长宁区', '静安区', '普陀区', '虹口区', '杨浦区', '闵行区', '宝山区', '嘉定区', '浦东新区', '金山区', '松江区', '青浦区', '奉贤区', '崇明区'],
            '广东省': {
                '广州市': ['天河区', '越秀区', '海珠区', '荔湾区', '白云区', '黄埔区', '番禺区', '花都区', '南沙区', '从化区', '增城区'],
                '深圳市': ['福田区', '罗湖区', '南山区', '盐田区', '宝安区', '龙岗区', '龙华区', '坪山区', '光明区'],
                '珠海市': ['香洲区', '斗门区', '金湾区'],
                '汕头市': ['金平区', '龙湖区', '濠江区', '潮阳区', '潮南区', '澄海区'],
                '佛山市': ['禅城区', '南海区', '顺德区', '三水区', '高明区'],
                '韶关市': ['浈江区', '武江区', '曲江区'],
                '湛江市': ['赤坎区', '霞山区', '坡头区', '麻章区'],
                '肇庆市': ['端州区', '鼎湖区', '高要区']
            },
            '浙江省': {
                '杭州市': ['上城区', '下城区', '江干区', '拱墅区', '西湖区', '滨江区', '萧山区', '余杭区', '富阳区', '临安区'],
                '宁波市': ['海曙区', '江北区', '北仑区', '镇海区', '鄞州区', '奉化区'],
                '温州市': ['鹿城区', '龙湾区', '瓯海区', '洞头区'],
                '嘉兴市': ['南湖区', '秀洲区'],
                '湖州市': ['吴兴区', '南浔区']
            },
            '江苏省': {
                '南京市': ['玄武区', '秦淮区', '建邺区', '鼓楼区', '浦口区', '栖霞区', '雨花台区', '江宁区', '六合区', '溧水区', '高淳区'],
                '苏州市': ['姑苏区', '虎丘区', '吴中区', '相城区', '吴江区', '常熟市', '张家港市', '昆山市', '太仓市'],
                '无锡市': ['梁溪区', '锡山区', '惠山区', '滨湖区', '新吴区'],
                '常州市': ['天宁区', '钟楼区', '新北区', '武进区', '金坛区'],
                '南通市': ['崇川区', '港闸区', '通州区']
            },
            '四川省': {
                '成都市': ['锦江区', '青羊区', '金牛区', '武侯区', '成华区', '龙泉驿区', '青白江区', '新都区', '温江区', '双流区', '郫都区'],
                '绵阳市': ['涪城区', '游仙区', '安州区'],
                '德阳市': ['旌阳区', '罗江区'],
                '泸州市': ['江阳区', '纳溪区', '龙马潭区']
            },
            '湖北省': {
                '武汉市': ['江岸区', '江汉区', '硚口区', '汉阳区', '武昌区', '青山区', '洪山区', '东西湖区', '汉南区', '蔡甸区', '江夏区', '黄陂区', '新洲区'],
                '宜昌市': ['西陵区', '伍家岗区', '点军区', '猇亭区', '夷陵区'],
                '襄阳市': ['襄城区', '樊城区', '襄州区'],
                '荆州市': ['沙市区', '荆州区']
            }
        }

        # 添加省份和城市数据
        for province_name, data in provinces_data.items():
            province = Region(name=province_name, level='province')
            db.session.add(province)
            db.session.flush()  # 获取ID

            if isinstance(data, list):
                # 直辖市的情况，直接添加区
                for district_name in data:
                    district = Region(
                        name=district_name,
                        level='district',
                        parent_id=province.id
                    )
                    db.session.add(district)
            else:
                # 普通省份，添加市和区
                for city_name, districts in data.items():
                    city = Region(
                        name=city_name,
                        level='city',
                        parent_id=province.id
                    )
                    db.session.add(city)
                    db.session.flush()

                    for district_name in districts:
                        district = Region(
                            name=district_name,
                            level='district',
                            parent_id=city.id
                        )
                        db.session.add(district)

        db.session.commit()
        print('数据库初始化完成！')

if __name__ == '__main__':
    init_db()